name: YW-Auto-Bot

on:
  workflow_dispatch: # 手动触发
  schedule:
    - cron: '1 */1 * * *'  # 每小时第1分钟执行

jobs:
  # 前置Job：生成用户矩阵数据（USER1~USER10）
  generate-matrix:
    runs-on: ubuntu-latest
    outputs:
      # 输出矩阵数据，供后续Job使用
      user-matrix: ${{ steps.set-matrix.outputs.users }}
    steps:
      - name: 生成USER1~USER10的矩阵列表
        id: set-matrix
        run: |
          # 使用shell命令生成用户列表（无需GitHub Actions内置函数）
          users=$(seq 1 10 | awk '{print "\"USER" $0 "\""}' | paste -sd "," -)
          # 格式化为GitHub Actions可识别的矩阵JSON格式
          echo "users=[${users}]" >> $GITHUB_OUTPUT

  # 核心Job：执行机器人脚本（引用前置Job生成的矩阵）
  execute-bot:
    needs: generate-matrix # 依赖前置Job，获取生成的矩阵
    runs-on: ubuntu-latest
    strategy:
      matrix:
        user: ${{ fromJSON(needs.generate-matrix.outputs.user-matrix) }} # 解析前置Job输出的矩阵
      max-parallel: 1 # 保持串行执行
      fail-fast: false # 可选，避免单个用户失败影响后续

    steps:
      # 第一步就验证Secrets，如果不存在则跳过整个Job
      - name: 1. 验证Secrets是否存在
        id: check-secrets
        run: |
          if [ -n "$TOKEN" ]; then
            echo "✅ 检测到${{ matrix.user }}对应的Secrets存在，继续执行后续步骤"
            echo "secrets_exist=true" >> $GITHUB_OUTPUT
          else
            echo "⚠️ 未检测到${{ matrix.user }}对应的Secrets，跳过整个Job"
            echo "secrets_exist=false" >> $GITHUB_OUTPUT
            # 使用GitHub Actions的特殊命令来跳过整个Job
            echo "::warning::跳过 ${{ matrix.user }} 的所有操作，因为未配置相应的Secrets"
            exit 0
          fi
        env:
          TOKEN: ${{ secrets[format('TOKEN_{0}', matrix.user)] }}

      - name: 2. 拉取代码
        uses: actions/checkout@v3

      - name: 3. 安装 Node.js 16
        uses: actions/setup-node@v3
        with:
          node-version: '16'
          cache: 'npm'

      - name: 4. 安装依赖
        run: npm install

      - name: 5. 执行机器人脚本
        run: node index.js
        env:
          TOKEN: ${{ secrets[format('TOKEN_{0}', matrix.user)] }}
          USER_NAME: ${{ matrix.user }}
